<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ block "title" . }}{{ with .Title }}{{ . }} | {{ end }}{{ .Site.Title }}{{ end }}</title>
  {{ $css := resources.Get "css/output.css" }}
  {{ with $css }}
  <link rel="stylesheet" href="{{ .RelPermalink }}">
  {{ end }}
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  {{ block "head" . }}{{ end }}
  <script>
    (function() {
      var theme = localStorage.getItem('theme') || 'system';
      var dark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (dark) document.documentElement.classList.add('dark');
    })();
  </script>
</head>

<body class="flex justify-center min-h-screen">
  <main class="w-full max-w-content px-4 pt-12 md:pt-28 pb-8">
    {{ block "main" . }}{{ end }}
  </main>
  <!-- Mobile top nav -->
  <nav class="fixed top-0 inset-x-0 z-50 md:hidden flex items-center justify-center gap-4 px-4 py-3 bg-tn-bg text-sm text-tn-text-muted">
    {{ range .Site.Menus.main }}
    <a href="{{ .URL }}" class="hover:text-tn-accent">{{ .Name }}</a>
    {{ end }}
    <button id="search-toggle-mobile" class="hover:text-tn-accent" aria-label="Search">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
    </button>
    <button id="theme-toggle-mobile" class="hover:text-tn-accent" aria-label="Toggle theme">
      <svg class="w-4 h-4 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
      </svg>
      <svg class="w-4 h-4 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
      </svg>
    </button>
  </nav>

  <!-- Desktop side nav -->
  <nav class="hidden md:flex fixed top-32 left-[calc(50%+360px+2rem)] flex-col gap-2 text-sm text-tn-text-muted">
    {{ range .Site.Menus.main }}
    <a href="{{ .URL }}" class="hover:text-tn-accent">{{ .Name }}</a>
    {{ end }}
    <button id="search-toggle" class="hover:text-tn-accent text-left relative group" aria-label="Search (⌘K)">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <span class="absolute left-6 top-1/2 -translate-y-1/2 px-2 py-1 text-[10px] rounded bg-tn-bg-secondary border border-tn-border text-tn-text-muted whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">⌘K</span>
    </button>
    <button id="theme-toggle" class="mt-2 hover:text-tn-accent text-left" aria-label="Toggle theme">
      <svg class="w-4 h-4 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
      </svg>
      <svg class="w-4 h-4 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
      </svg>
    </button>
  </nav>

  <!-- Search modal -->
  <div id="search-modal" class="search-modal" aria-hidden="true">
    <div class="search-backdrop" id="search-backdrop"></div>
    <div class="search-container">
      <input type="text" id="search-input" class="search-input" placeholder="Search..." autocomplete="off" />
      <div id="search-results" class="search-results"></div>
    </div>
  </div>

  <script>
    (function() {
      var modal = document.getElementById('search-modal');
      var backdrop = document.getElementById('search-backdrop');
      var input = document.getElementById('search-input');
      var results = document.getElementById('search-results');
      var pagefind = null;

      function openSearch() {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        input.value = '';
        results.innerHTML = '';
        input.focus();
      }

      function closeSearch() {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
      }

      document.addEventListener('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (modal.classList.contains('active')) {
            closeSearch();
          } else {
            openSearch();
          }
        }
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeSearch();
        }
      });

      backdrop.addEventListener('click', closeSearch);
      document.getElementById('search-toggle').addEventListener('click', openSearch);
      document.getElementById('search-toggle-mobile').addEventListener('click', openSearch);

      var debounceTimer;
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        var query = input.value;
        if (!query) {
          results.innerHTML = '';
          return;
        }
        debounceTimer = setTimeout(async function() {
          if (!pagefind) {
            pagefind = await import('/pagefind/pagefind.js');
            await pagefind.init();
          }
          var search = await pagefind.search(query);
          var items = await Promise.all(search.results.slice(0, 8).map(function(r) { return r.data(); }));
          if (!items.length) {
            results.innerHTML = '<p class="search-empty">No results found.</p>';
            return;
          }
          results.innerHTML = items.map(function(item) {
            return '<a href="' + item.url + '" class="search-result">'
              + '<span class="search-result-title">' + item.meta.title + '</span>'
              + '<span class="search-result-excerpt">' + (item.excerpt || '') + '</span>'
              + '</a>';
          }).join('');
        }, 200);
      });
    })();
  </script>

  <script>
    (function() {
      function isDark() {
        return document.documentElement.classList.contains('dark');
      }
      function toggle() {
        var dark = !isDark();
        document.documentElement.classList.toggle('dark', dark);
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      }
      document.getElementById('theme-toggle').addEventListener('click', toggle);
      document.getElementById('theme-toggle-mobile').addEventListener('click', toggle);
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        if (!localStorage.getItem('theme') || localStorage.getItem('theme') === 'system') {
          var dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.classList.toggle('dark', dark);
        }
      });
    })();
  </script>
</body>

</html>
